# game.gd
extends Node3D

@onready var music_player = $MusicPlayer

# 游戏内的当前时间（秒）
var song_position_sec: float = 0.0
# 歌曲是否正在播放
var is_playing: bool = false
# 地面轨道对应的x轴坐标
const TRACKS_X = [-2.85, -1.6, -0.525, 0.525, 1.6, 2.85]
# 地面轨道对应的y轴坐标
const TRACKS_Y = [0.4, 0.025, 0.025, 0.025, 0.025, 0.4]
# 地面轨道对应的z轴旋转
const TRACKS_ROTATION = [-30, 0, 0, 0, 0, 30]
# 地面轨道对应的x轴缩放
const TRACKS_SCALE = [1.5, 1, 1, 1, 1, 1.5]
# Note下落的距离（z轴）
const NOTE_SPAWN_Z = -50.0
# Note流速，单位：游戏单位/秒
const NOTE_SPEED = 40.0
# 预加载Note场景
const NOTE_SCENE = preload("res://Scenes/note.tscn")


# 临时存放谱面数据
# 格式：[额定击打时间（秒）, 所在轨道（0-5）]
var chart_data = [
	[3.84, 2],
	[4.51, 3],
	[5.18, 4],
	[6.54, 1],
	[7.21, 0],
	[8.56, 5],
	[9.23, 4],
	[9.90, 3],
	[11.25, 1],
	[11.93, 2],
	[12.60, 0],
	[13.84, 2],
	[13.84, 3],
	[14.18, 1],
	[14.18, 4],
	[14.51, 2],
	[14.85, 1],
	[14.85, 4],
	[15.19, 3],
	[15.52, 2],
	[15.52, 3],
	[15.86, 1],
	[15.86, 4],
	[16.20, 2],
	[16.53, 1],
	[16.53, 4],
	[16.87, 0],
	[17.21, 5],
	[17.55, 1],
	[17.88, 4],
	[18.22, 0],
	[18.56, 5],
	[18.90, 1],
	[19.23, 4],
	[19.57, 2],
	[19.91, 3],
	[20.24, 0],
	[20.58, 5],
	[20.92, 1],
	[21.25, 4],
	[21.59, 2],
	[21.93, 3],
	[22.27, 1],
	[22.60, 4],
	[22.94, 0],
	[23.28, 5],
	[23.61, 2],
	[23.95, 3],
	[24.29, 0],
	[24.45, 1],
	[24.62, 2],
	[24.79, 3],
	[24.96, 4],
	[25.13, 5],
	[25.29, 0],
	[25.29, 3],
	[25.46, 1],
	[25.63, 2],
	[25.79, 1],
	[25.79, 4],
	[25.96, 3],
	[26.13, 2],
	[26.30, 3],
	[26.30, 5],
	[26.46, 4],
	[26.63, 3],
	[26.80, 1],
	[26.80, 4],
	[26.97, 2],
	[27.13, 1],
	[27.30, 0],
	[27.30, 3],
	[27.47, 1],
	[27.64, 2],
	[27.80, 1],
	[27.80, 4],
	[27.97, 3],
	[28.14, 2],
	[28.31, 2],
	[28.31, 5],
	[28.47, 4],
	[28.64, 3],
	[28.81, 1],
	[28.81, 4],
	[28.98, 2],
	[29.14, 0],
	[29.48, 1],
	[29.82, 2],
	[30.15, 3],
	[30.32, 2],
	[30.49, 1],
	[30.66, 0],
	[30.82, 1],
	[30.99, 2],
	[31.16, 3],
	[31.33, 4],
	[31.49, 5],
	[31.66, 0],
	[31.66, 3],
	[31.83, 1],
	[31.99, 2],
	[32.16, 1],
	[32.16, 4],
	[32.33, 3],
	[32.50, 2],
	[32.66, 3],
	[32.66, 5],
	[32.83, 4],
	[33.00, 3],
	[33.17, 1],
	[33.17, 4],
	[33.33, 2],
	[33.50, 1],
	[33.67, 0],
	[33.67, 3],
	[33.84, 1],
	[34.00, 2],
	[34.17, 1],
	[34.17, 4],
	[34.34, 3],
	[34.51, 2],
	[34.67, 2],
	[34.67, 5],
	[34.84, 4],
	[35.01, 3],
	[35.17, 1],
	[35.17, 4],
	[35.34, 2],
	[35.51, 0],
	[35.85, 1],
	[36.18, 2],
	[36.52, 3],
	[36.86, 4],
	[37.19, 5],
	[37.53, 0],
	[37.87, 1],
	[38.20, 2],
	[38.54, 3],
	[38.88, 4],
	[39.21, 5],
	[39.55, 2],
	[39.55, 3],
	[39.89, 1],
	[40.22, 4],
	[40.56, 0],
	[40.90, 5],
	[41.23, 1],
	[41.57, 4],
	[41.91, 2],
	[42.24, 3],
	[42.58, 1],
	[42.92, 4],
	[43.25, 0],
	[43.59, 5],
	[43.93, 2],
	[44.27, 3],
	[44.60, 1],
	[44.77, 2],
	[44.94, 3],
	[45.10, 4],
	[45.27, 5],
	[46.62, 2],
	[46.96, 0],
	[46.96, 5],
	[47.29, 3],
	[47.63, 1],
	[47.63, 4],
	[47.97, 2],
	[48.64, 0],
	[48.98, 2],
	[49.31, 1],
	[49.65, 3],
	[49.99, 4],
	[50.32, 2],
	[50.66, 0],
	[50.66, 5],
	[50.99, 1],
	[51.33, 4],
	[51.67, 3],
	[52.34, 2],
	[52.68, 1],
	[53.01, 4],
	[53.35, 3],
	[53.69, 5],
	[54.02, 0],
	[54.36, 1],
	[54.36, 4],
	[54.70, 2],
	[55.03, 3],
	[55.37, 1],
	[55.71, 0],
	[56.04, 2],
	[56.38, 5],
	[56.72, 3],
	[57.05, 1],
	[57.05, 4],
	[57.39, 0],
	[58.06, 5],
	[58.40, 4],
	[58.74, 3],
	[59.07, 2],
	[59.41, 1],
	[59.75, 0],
	[59.75, 5],
	[100.09, 2],
	[100.42, 1],
	[100.76, 3],
	[101.10, 0],
	[101.43, 4],
	[101.77, 2],
	[102.11, 5],
	[102.44, 3],
	[102.78, 1],
	[102.78, 4],
	[103.12, 2],
	[103.45, 0],
	[103.79, 3],
	[104.13, 5],
	[104.46, 1],
	[104.80, 4],
	[105.14, 2],
	[105.47, 3],
	[105.81, 0],
	[105.81, 5],
	[106.15, 1],
	[106.48, 4],
	[106.82, 2],
	[107.16, 3],
	[107.49, 1],
	[107.83, 4],
	[108.17, 0],
	[108.33, 1],
	[108.50, 2],
	[108.67, 3],
	[108.84, 4],
	[109.00, 5],
	[109.17, 0],
	[109.17, 3],
	[109.34, 1],
	[109.51, 2],
	[109.67, 1],
	[109.67, 4],
	[109.84, 3],
	[110.01, 2],
	[110.17, 3],
	[110.17, 5],
	[110.34, 4],
	[110.51, 3],
	[110.68, 1],
	[110.68, 4],
	[110.84, 2],
	[111.01, 1],
	[111.18, 0],
	[111.18, 3],
	[111.35, 1],
	[111.51, 2],
	[111.68, 1],
	[111.68, 4],
	[111.85, 3],
	[112.02, 2],
	[112.18, 2],
	[112.18, 5],
	[112.35, 4],
	[112.52, 3],
	[112.68, 1],
	[112.68, 4],
	[112.85, 2],
	[113.02, 0],
	[113.36, 1],
	[113.69, 2],
	[114.03, 3],
	[114.20, 2],
	[114.36, 1],
	[114.53, 0],
	[114.70, 1],
	[114.86, 2],
	[115.03, 3],
	[115.20, 4],
	[115.37, 5],
	[115.53, 0],
	[115.53, 3],
	[115.70, 1],
	[115.87, 2],
	[116.04, 1],
	[116.04, 4],
	[116.20, 3],
	[116.37, 2],
	[116.54, 3],
	[116.54, 5],
	[116.71, 4],
	[116.87, 3],
	[117.04, 1],
	[117.04, 4],
	[117.21, 2],
	[117.38, 1],
	[117.54, 0],
	[117.54, 3],
	[117.71, 1],
	[117.88, 2],
	[118.04, 1],
	[118.04, 4],
	[118.21, 3],
	[118.38, 2],
	[118.55, 2],
	[118.55, 5],
	[118.71, 4],
	[118.88, 3],
	[119.05, 1],
	[119.05, 4],
	[119.22, 2],
	[119.38, 0],
	[119.72, 1],
	[120.06, 2],
	[120.39, 3],
	[120.73, 4],
	[121.07, 5],
	[121.40, 0],
	[121.74, 1],
	[122.08, 2],
	[122.41, 3],
	[122.75, 4],
	[123.09, 5],
	[123.42, 2],
	[123.42, 3],
	[123.76, 1],
	[124.10, 4],
	[124.43, 0],
	[124.77, 5],
	[125.11, 1],
	[125.44, 4],
	[125.78, 2],
	[126.12, 3],
	[126.45, 1],
	[126.79, 4],
	[127.13, 0],
	[127.46, 5],
	[127.80, 2],
	[128.14, 3],
	[128.47, 1],
	[128.64, 2],
	[128.81, 3],
	[128.98, 4],
	[129.14, 5],
	[129.48, 2],
	[129.82, 3],
	[130.15, 1],
	[130.49, 4],
	[130.82, 0],
	[131.16, 5],
	[131.50, 2],
	[131.83, 3],
	[132.17, 1],
	[132.51, 4],
	[132.84, 0],
	[133.18, 5],
	[133.52, 2],
	[133.85, 3],
	[134.19, 1],
	[134.53, 4],
	[134.86, 0],
	[135.20, 5],
	[135.54, 2],
	[135.87, 3],
	[136.21, 1],
	[136.55, 4],
	[136.88, 0],
	[137.22, 5],
	[137.56, 2],
	[137.89, 3],
	[138.23, 1],
	[138.57, 4],
	[138.90, 0],
	[139.24, 5],
	[139.58, 2],
	[139.91, 3],
	[140.25, 1],
	[140.59, 4],
	[140.92, 0],
	[141.26, 5],
	[141.60, 2],
	[141.93, 3],
	[142.27, 1],
	[142.61, 4],
	[142.94, 0],
	[143.28, 5],
	[143.62, 2],
	[143.95, 3],
	[144.29, 1],
	[144.63, 4],
	[144.96, 0],
	[145.30, 5],
	[145.64, 2],
	[145.97, 3],
	[146.31, 1],
	[146.65, 4],
	[146.98, 0],
	[147.32, 5],
	[147.66, 2],
	[147.99, 3],
	[148.33, 1],
	[148.67, 4],
	[149.00, 0],
	[149.34, 5],
	[149.68, 2],
	[150.01, 3],
	[150.35, 1],
	[150.69, 4],
	[151.02, 0],
	[151.36, 5],
	[151.70, 2],
	[152.03, 3],
	[152.37, 1],
	[152.71, 4],
	[153.04, 0],
	[153.38, 5],
	[153.72, 2],
	[154.05, 3],
	[154.39, 1],
	[154.73, 4],
	[155.06, 0],
	[155.40, 5],
	[155.74, 2],
	[156.07, 3],
	[156.41, 1],
	[156.75, 4],
	[157.08, 0],
	[157.42, 5],
	[157.76, 2],
	[158.09, 3],
	[158.43, 1],
	[158.77, 4],
	[159.10, 0],
	[159.44, 5],
	[159.78, 2],
	[160.11, 3],
	[160.45, 1],
	[160.79, 4],
	[161.12, 0],
	[161.46, 5],
	[161.80, 2],
	[162.13, 3],
	[162.47, 1],
	[162.81, 4],
	[163.14, 0],
	[163.48, 5],
	[163.82, 2],
	[164.15, 3],
	[164.49, 1],
	[164.83, 4],
	[165.16, 0],
	[165.50, 5],
	[165.84, 2],
	[166.17, 3],
	[166.51, 1],
	[166.85, 4],
	[167.18, 0],
	[167.52, 5],
	[167.86, 2],
	[168.19, 3],
	[168.53, 1],
	[168.87, 4],
	[169.20, 0],
	[169.54, 5],
	[169.88, 2],
	[170.21, 3],
	[170.55, 1],
	[170.89, 4],
	[171.22, 0],
	[171.56, 5],
	[171.90, 2],
	[172.23, 3],
	[172.57, 1],
	[172.91, 4],
	[173.24, 0],
	[173.58, 5],
	[173.92, 2],
	[174.25, 3],
	[174.59, 1],
	[174.93, 4],
	[175.26, 0],
	[175.60, 5],
	[175.94, 2],
	[176.27, 3],
	[176.61, 1]
]

var next_note_index = 0

func _ready():
	# 游戏开始时调用
	start_song()

func start_song():
	is_playing = true
	music_player.play()

func _process(delta):
	if not is_playing:
		return
	
	# 从AudioStreamPlayer获取权威时间，这是最精准的
	song_position_sec = music_player.get_playback_position()
	
	# --- Note 生成逻辑 ---
	# 检查是否还有未生成的note
	if next_note_index < chart_data.size():
		var next_note = chart_data[next_note_index]
		var note_time = next_note[0]
		
		# 计算Note应该在何时生成
		# 它需要 (NOTE_SPAWN_Z / NOTE_SPEED) 秒来下落
		var spawn_lead_time = abs(NOTE_SPAWN_Z) / NOTE_SPEED
		
		# 如果当前时间已经进入了note的生成窗口期
		if song_position_sec >= note_time - spawn_lead_time:
			spawn_note(note_time, next_note[1])
			next_note_index += 1

func spawn_note(time, track):
	var note_instance = NOTE_SCENE.instantiate()
	
	# 设置note的属性
	note_instance.target_time = time
	note_instance.track = track
	note_instance.note_spawn_time = song_position_sec
	note_instance.note_spawn_z = NOTE_SPAWN_Z
	
	# 设置note的初始位置及旋转
	note_instance.position.x = TRACKS_X[track]
	note_instance.position.y = TRACKS_Y[track]
	note_instance.position.z = NOTE_SPAWN_Z
	note_instance.scale.x = TRACKS_SCALE[track]
	note_instance.rotation_degrees.z = TRACKS_ROTATION[track]
	
	# 把它添加到场景树中
	add_child(note_instance)
